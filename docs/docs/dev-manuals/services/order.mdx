import CustomImage from "@site/src/components/CustomImage";

# Order Service

The order service provides the bounded context `Order`.
It is responsible for managing orders of users.

## Domain Model

<CustomImage path="/renderedDiagrams/orderDomainModel" width="1365" height="131" />

:::info

Imported entities from other bounded contexts are marked with a dashed border.

:::

## API

The service provides a GraphQL API, which is documented in the [GraphQL API documentation](/docs/graphql/order).

## Technology Stack

- **Language**: Rust
- **Framework**: [axum](https://docs.rs/axum/latest/axum/)
- **GraphQL Library**: [async_graphql](https://docs.rs/async-graphql/latest/async_graphql/)
- **Database**: MongoDB

## Repository Structure

The repository is structured as follows:

<div className="repository-structure">
- `/src`: Source code of the service
  - `authentication.rs` Header authentication logic of service
  - `base_connection.rs` Generic GraphQL connection
  - `order_connection.rs` GraphQL connection of discount
  - `foreign_types.rs` Datatypes which are not part of the services bounded context
  - `http_event_service.rs` Handling of incoming events
  - `main.rs` Service execution and schema generation
  - `mutation_input_structs.rs` GraphQL input datatypes for mutations
  - `mutation.rs` GraphQL mutations and associated functions
  - `order_compenstation.rs` Compensation logic on `shipment/shipment/creation-failed` event
  - `order_connection.rs` GraphQL connection of order
  - `order_datatypes.rs` GraphQL datatypes for connection element ordering
  - `order_item_connection.rs` GraphQL connection of an order item
  - `order_item.rs` Order item datatype
  - `order.rs` Order datatype
  - `query.rs` GraphQL queries and associated functions
  - `user.rs` User with additional GraphQL field(s) provided by this service
</div>

## Defined Events

This section lists events that are defined by the order service and can be used by other services.

```tsx
interface Order {
  id: string,
  userId: string,
  createdAt: Date,
  orderStatus: OrderStatus,
  placedAt: Date,
  rejectionReason?: RejectionReason,
  orderItems: OrderItem[],
  shipmentAddressId: string,
  invoiceAddressId: string,
  compensatableOrderAmount: number,
  paymentInformationId, string,
}

interface OrderItem {
  id: string,
  createdAt: Date,
  productVariantId: string,
  productVariantVersionId: string,
  taxRateVersionId: string,
  shoppingCartItemId: string,
  count: number,
  compensatableAmount: number,
  shipmentMethodId, string,
  discountIds: string[],
}

enum OrderStatus {
  PENDING,
  PLACED,
  REJECTED
}

enum RejectionReason {
  INVALID_ORDER_DATA,
  INVENTORY_RESERVATION_FAILED
}
```

### Published Defined Events

#### invoice/invoice/created

This event is published when an order is placed, which means its order status is set to `PLACED`.

This events body is similar to the `interface Order`.

### Subscribed Defined Events

n/a

## Imported Events

This section lists events defined by other services that are used by the order service.

### Published Imported Events

n/a

### Subscribed Imported Events

- [catalog/product-variant-version/created](/docs/docs/dev-manuals/services/catalog#catalogproduct-variant-versioncreated): Used to obtain the current product variant versions for product variants.
- [discount/coupon/created](/docs/docs/dev-manuals/services/discount#discountcouponcreated): Used to validate the existence of coupons.
- [tax/tax-rate-version/created](/docs/docs/dev-manuals/services/tax#taxtax-rate-versioncreated): Used to obtain the current tax rate versions for tax rates.
- [shipment/shipment-method/created](/docs/docs/dev-manuals/services/tax#shipmentshipment-methodcreated): Used to validate the existence of shipment methods.
- [user/user/created](/docs/docs/dev-manuals/services/user#userusercreated): Used to validate that orders belong to an existing user.
- [address/user-address/created](/docs/docs/dev-manuals/services/address#addressuser-addresscreated): Used to validate that addresses exist for a user.
- [shipment/shipment/creation-failed](/docs/docs/dev-manuals/services/shipment#shipmentshipmentcreation-failed): Used to trigger order compensation for a shipment.

## Important ADRs

n/a
